
@model FormProduct
@{
    ViewData["Title"] = "Updated";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
@section styles{
    <link href="~/lib/media-preview-upload/css/style.css" rel="stylesheet" />
}
<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            Cập nhật sản phẩm
        </h3>
        <p class="card-subtitle">@Model.Products.Title</p>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <form asp-action="Updated" method="post" enctype="multipart/form-data">
                    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                    <input type="hidden" asp-for="Products.Id" value="@Model.Products.Id" />
                    <div class="form-group">
                        <label asp-for="Products.Code" class="control-label"></label>
                        <input asp-for="Products.Code" type="text" class="form-control" value="@Model.Products.Code" />
                        <span asp-validation-for="Products.Code" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Title" class="control-label"></label>
                        <input asp-for="Products.Title" type="text" class="form-control Title" value="@Model.Products.Title" />
                        <span asp-validation-for="Products.Title" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Slug" class="control-label"></label>
                        <input asp-for="Products.Slug" type="text" class="form-control" value="@Model.Products.Slug" id="permalink" readonly />
                        <span asp-validation-for="Products.Slug" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Description" class="control-label"></label>
                        <input asp-for="Products.Description" type="text" class="form-control" value="@Model.Products.Description" />
                        <span asp-validation-for="Products.Description" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Detail" class="control-label"></label>
                        <input asp-for="Products.Detail" type="text" class="form-control" value="@Model.Products.Detail" />
                        <span asp-validation-for="Products.Detail" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.CategoryId" class="control-label"></label>
                        <select asp-for="Products.CategoryId" class="form-control">
                            <option value="-1">Chọn</option>
                            @foreach (var item in Model.Products.categories)
                            {
                                if (Model.Products.CategoryId == item.Id)
                                {
                                    <option value="@item.Id" selected>@item.Title</option>
                                }
                                else
                                {
                                    <option value="@item.Id">@item.Title</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="Products.CategoryId" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.BrandId" class="control-label"></label>
                        <select asp-for="Products.BrandId" class="form-control">
                            <option value="-1">Chọn</option>
                            @foreach (var item in Model.Products.brands)
                            {
                                if (Model.Products.BrandId == item.Id)
                                {
                                    <option value="@item.Id" selected>@item.Name</option>
                                }
                                else
                                {
                                    <option value="@item.Id">@item.Name</option>
                                }
                            }
                        </select>
                        <span asp-validation-for="Products.BrandId" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Price" class="control-label"></label>
                        <input asp-for="Products.Price" class="form-control" value="@Model.Products.Price" />
                        <span asp-validation-for="Products.Price" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label asp-for="Products.Sale" class="control-label"></label>
                        <input asp-for="Products.Sale" class="form-control" value="@Model.Products.Sale" />
                        <span asp-validation-for="Products.Sale" class="text-danger"></span>
                    </div>
                    @*="~/user-content/@Model.Products.ThumbnailImageUrl*@
                    <div class="form-group ">
                        <label class="control-label">Ảnh</label>

                        <input asp-for="ThumbnailImage" class="form-control-file" type="file" id="thumbnail" onchange="previewFile(this)" hidden />
                        <span asp-validation-for="ThumbnailImage" class="text-danger"></span>
                        <br />
                        <img id="previewThumbnail" src="~/user-content/@Model.Products.ThumbnailImageUrl" width="90" />
                        <br />
                        <label for="thumbnail" class="btn btn-primary mt-1">Chọn ảnh</label>

                        <span asp-validation-for="ThumbnailImage" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <label class="control-label">Danh sách hình ảnh</label>
                        <ul class="media-list" id="media-list">
                            @foreach (var item in Model.Products.ProductImages)
                            {
                                <li>
                                    <img src="@item.MediaUrl" />
                                    <div class="post-thumb"><div class="inner-post-thumb"><a href="javascript:void(0);" data-id="@item.Media" class="remove-pic"><i class="fa fa-times" aria-hidden="true"></i></a><div></div></div></div>
                                </li>
                            }
                            <li class="myupload">
                                <span>
                                    <i class="fa fa-plus" aria-hidden="true" for="ProductImages"></i>
                                    <input asp-for="ProductImages" class="form-control-file " id="ProductImages" type="file" multiple name="ProductImages" />
                                </span>
                                <input asp-for="ListDelete" id="Delete" name="ListDelete" hidden />
                            </li>
                        </ul>
                        <span asp-validation-for="ProductImages" class="text-danger"></span>
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Save" class="btn btn-primary" />

                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="card-footer">
        <a asp-action="Index" class="card-link">Back to List</a>
    </div>
</div>

@section Scripts {
    <script src="~/lib/Slug/speakingurl.min.js"></script>
    <script src="~/lib/Slug/jquery.stringtoslug.js"></script>
    <script>
        function previewFile(input) {
            var file = $(input).get(0).files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function () {
                    $("#previewThumbnail").attr("src", reader.result);
                }
                reader.readAsDataURL(file);
            }
        };
        $(function () {
            var names = @Html.Raw(Json.Serialize(Model.Products.ProductImages.Select(x => x.Media).ToList()));
            var ListDelete = [];
            function previewFile(input) {
                var file = $(input).get(0).files[0];
                if (file) {
                    var reader = new FileReader();
                    reader.onload = function () {
                        $("#previewThumbnail").attr("src", reader.result);
                    }
                    reader.readAsDataURL(file);
                }
            };
            $('body').on('change', '#ProductImages', function (event) {
                var files = event.target.files;
                for (var i = 0; i < files.length; i++) {
                    var file = files[i];
                    names.push($(this).get(0).files[i].name);
                    if (file.type.match('image')) {

                        var picReader = new FileReader();
                        picReader.fileName = file.name
                        picReader.addEventListener("load", function (event) {

                            var picFile = event.target;

                            var div = document.createElement("li");

                            div.innerHTML = "<img src='" + picFile.result + "'" +
                                "title='" + picFile.name + "'/><div  class='post-thumb'><div class='inner-post-thumb'><a href='javascript:void(0);' data-id='" + event.target.fileName + "' class='remove-pic'><i class='fa fa-times' aria-hidden='true'></i></a><div></div>";

                            $("#media-list").prepend(div);

                        });
                    } else {
                        var picReader = new FileReader();
                        picReader.fileName = file.name
                        picReader.addEventListener("load", function (event) {

                            var picFile = event.target;

                            var div = document.createElement("li");

                            div.innerHTML = "<video src='" + picFile.result + "'" +
                                "title='" + picFile.name + "'></video><div class='post-thumb'><div  class='inner-post-thumb'><a href='javascript:void(0);' data-id='" + event.target.fileName + "' class='remove-pic'><i class='fa fa-times' aria-hidden='true'></i></a><div></div>";

                            $("#media-list").prepend(div);

                        });
                    }
                    picReader.readAsDataURL(file);

                }

            });
            $('body').on('click', '.remove-pic', function () {
                $(this).parent().parent().parent().remove();
                var removeItem = $(this).attr('data-id');
                var yet = names.indexOf(removeItem);
                ListDelete.push(removeItem);
                var ListDeleteStr = JSON.stringify(ListDelete);
                $('#Delete').val(ListDeleteStr);
                if (yet != -1) {
                    names.splice(yet, 1);
                }
             });
            });

        $(document).ready(function () {
            $(".Title").stringToSlug();
         
        });
        $("#permalink").change(() => {
            console.log($("#permalink").val());
        })
     
    </script>
    <script src="~/lib/media-preview-upload/js/app.js"></script>

}
