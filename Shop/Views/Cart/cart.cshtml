@model CheckoutViewModel

<h2>GIỎ HÀNG</h2>
@section head{
    <link rel="stylesheet" href="../css/cart.css">
}
@if (Model.CartItems.Count > 0)
{
    decimal? total = 0;
    int stt = 1;
<main>
    <div id="woocommerce">

    </div>
    <div id="cart">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="cart">
                        <table class="table">
                            <thead>
                                <tr>
                                    <td scope="col"><span class="hidden-sm-down ">Sản phẩm</span></td>
                                    <td scope="col" width="120" class="hidden-sm-down ">Giá</td>
                                    <td scope="col" width="100">Số lượng</td>
                                    <td scope="col" width="120" class="hidden-sm-down ">Tổng</td>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.CartItems)
                                {
                                    decimal? thanhtien = 0;
                                    if (item.product.Sale == null)
                                    {
                                        thanhtien += item.quantity * item.product.Price;
                                        total += thanhtien;
                                    }
                                    else
                                    {
                                        thanhtien += item.quantity * item.product.Sale;
                                        total += thanhtien;
                                    }

                                    <tr class="item-in-cart" data-id="@item.Id">
                                        <td>
                                            <div class="cart-item-details" style="display:flex;">
                                                <div>
                                                    <a href="../html/single.html"><img src="https://localhost:5002/user-content/@item.product.Thumbnail.FileName"></a>
                                                </div>


                                                <div class="cart-item-price hidden-md-up">
                                                    <a href="../html/single.html">@item.product.Title</a>
                                                    <p class="no-margin">
                                                        <span>@item.quantity</span> X <span class="price">
                                                            @if (item.product.Sale == null)
                                                            {
                                                                @(item.product.Price)
                                                            }
                                                            else
                                                            {
                                                                @(item.product.Sale)
                                                            }
                                                        </span>
                                                    </p>
                                                    <a class="remove-in-cart">Remove</a>
                                                </div>

                                            </div>
                                        </td>
                                        <td class="hidden-sm-down">
                                            <div class="cart-item-price">
                                                @if (item.product.Sale == null)
                                                {
                                                    <span style="color:black">@item.product.Price</span>
                                                }
                                                else
                                                {
                                                    <span style="color:black">@item.product.Sale</span>
                                                    <i class="fa fa-caret-left" aria-hidden="true"></i>
                                                    <span><del>@item.product.Price</del></span>
                                                }

                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="cart-item-quantity">
                                                <div class="quantity">
                                                    <div class="wrap-num-product">
                                                        <div class="btn-num-product-down">
                                                            <i class="fa fa-minus" aria-hidden="true"></i>
                                                        </div>
                                                        <input class="txt-center num-product" type="number" name="num-product" value="@item.quantity">

                                                        <div class="btn-num-product-up">
                                                            <i class="fa fa-plus" aria-hidden="true"></i>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="hidden-sm-down">
                                            @if (item.product.Sale == null)
                                            {
                                                @(item.product.Price * item.quantity)
                                            }
                                            else
                                            {
                                                @(item.product.Sale * item.quantity)
                                            }
                                        </td>
                                    </tr>
                                }

                            </tbody>
                        </table>
                    </div>

                    <hr>
                    <a class="return-shop" asp-controller="Product" asp-action="index"><i class="fa fa-angle-left" aria-hidden="true"></i> Tiếp tục mua hàng </a>
                </div>
                <div class="col-md-4 total">
                    <div class="box">

                        <h3 class="title">Tổng đơn hàng</h3>

                        <table class="table">
                            <tbody>
                                <tr>
                                    <td>Tổng</td>
                                    <td class="text-right">@total <small>₫</small></td>
                                </tr>
                                <tr>
                                    <td>Phí vận chuyển</td>
                                    <td class="text-right">25.000 <small>₫</small></td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        Mã giảm giá
                                        <br>
                                        <input class="input_style1 m_t_10" type="text" name="discount">
                                    </td>

                                </tr>
                                <tr>
                                    <td>Thanh toán</td>
                                    <td class="text-right">@(total + 25000) <small>₫</small></td>
                                </tr>
                            </tbody>
                        </table>
                        <a asp-controller="cart" asp-action="checkout" class="btn btn-black">Thanh toán</a>

                    </div>
                </div>
            </div>

        </div>

    </div>
    <div class="clearfix"></div>
    <div class="product">
        <div class="container">
            <div class="row">
                <h2 class="title">Sản phẩm vừa xem</h2>
                @if (Model.Viewed.Count > 0)
                {
                    @foreach (var item in Model.Viewed)
                    {
                        <div class="col-md-3 col-6 item-product">
                            <div class="product-grid6">
                                <div class="product-image6">
                                    <a href="chi-tiet/@item.Slug">
                                        <img class="pic-1" src="https://localhost:5002/user-content/@item.Thumbnail.FileName">
                                    </a>
                                </div>
                                <div class="product-content">
                                    <h3 class="title"><a href="chi-tiet/@item.Slug">@item.Title</a></h3>
                                    <div>
                                        @if (item.Sale > 0)
                                        {
                                            <span>@item.Sale ₫</span>
                                            <i class="fa fa-caret-left" aria-hidden="true"></i>
                                            <span class="sale"><del>@item.Price ₫</del></span>
                                        }
                                        else
                                        {
                                            <span><del>@item.Price ₫</del></span>
                                        }
                                    </div>
                                </div>
                                <ul class="social">
                                    <li><a href="/chi-tiet/@item.Slug" class="js-show-modal1" data-tip="Quick View"><i class="fa fa-search"></i></a></li>
                                    <li><a href="" class="js-add-wishlist" data-status="true" data-id="6" data-tip="Add to Wishlist"><i class="fal fa-heart"></i></a></li>
                                    <li><a href="" class="js-add-cart" data-status="true" data-id="6" data-tip="Add to Cart"><i class="fa fa-shopping-basket" aria-hidden="true"></i></a></li>
                                </ul>
                            </div>
                        </div>
                    }
                }



            </div>
        </div>
    </div>
</main>
}
else
{
    <p class="alert alert-danger">Giỏ hàng trống</p>
}
@section Scripts{
<script>
    $(document).on('click', '.remove-in-cart', function (e) {
        var parent = $(this).parents('.item-in-cart');
            var id = parseInt(parent.attr('data-id'));
            $.ajax({
                type: 'POST',
                url: '@Url.ActionLink("RemoveCart","Cart")',
                data: {
                    productid: id,
                },
                success: function (result) {
                    //  addtocart();
                    window.location.href = '@Url.ActionLink("cart","cart")';
                }
            })
        });
    $(document).on('change', '.num-product', function () {
        var parent = $(this).parents('.item-in-cart');
        var id = parseInt(parent.attr('data-id'));
        var value = parseInt($(this).val());
        console.log(value);
        if (value == null || value == '') {
            (this).val();
        } else {
            $.ajax({
                type: 'POST',
                url: '@Url.ActionLink("UpdateCart", "Cart")',
                data: {
                    productid: id,
                    quantity: value,
                },
                success: function (result) {
                    //addtocart();
                            window.location.href = '@Url.ActionLink("cart","cart")';
                }
            });
        }
    })
    $(document).on('click', '.fa-plus', function () {
        var parent = $(this).parents('.item-in-cart');
        var id = parseInt(parent.attr('data-id'));
        var value = parseInt(parent.find('.num-product').val());
        value++;
        $.ajax({
            type: 'POST',
            url: '@Url.ActionLink("UpdateCart", "Cart")',
            data: {
                productid: id,
                quantity: value,
            },
            success: function (result) {
                // addtocart();
                        window.location.href = '@Url.ActionLink("cart","cart")';
            }
        });
    });
    $(document).on('click', '.fa-minus', function () {
        var parent = $(this).parents('.item-in-cart');
        var id = parseInt(parent.attr('data-id'));
        var value = parseInt(parent.find('.num-product').val());
        if (value == 1) {
            $.ajax({
                type: 'POST',
                url: '@Url.ActionLink("RemoveCart", "Cart")',
                data: {
                    productid: id,
                },
                success: function (result) {
                    addtocart();
                }
            });
        } else
        {
            value--;
            $.ajax({
                type: 'POST',
                url: '@Url.ActionLink("UpdateCart", "Cart")',
                data: {
                    productid: id,
                    quantity: value,
                },
                success: function (result) {
                    // addtocart();
                    window.location.href = '@Url.ActionLink("cart","cart")';
                }
            });
        }
    });
</script>
}